{% extends "offcanvas.html" %}
{% load static sekizai_tags idea_tags socialee_filters %}

{% block content %}

<div class="row align-center">
  <div class="small-11 medium-10 large-10 columns">
    <div class="c-box">

      <div class="row align-center">
        <div class="small-12 medium-10 large-10 columns">
          
          <h2 class="text-center mb-2rem">{{ idea.title }}</h2>
          <img src="{{ MEDIA_URL }}{{ idea.picture }}">
          <p class="text-center mt-2rem">{{ idea.description|urlizetrunc:25|url_target_blank|safe }}</p>

          <div class="black-c-box small">

            {% if request.user.is_authenticated %}
              <h5 class="idea-comments__title">Diskutiere mit bei {{ idea.title }}</h5>
              <div class="idea-comments__input">

                  <textarea autofocus="autofocus" class="idea_comment_input" id="idea_comment_{{idea.id}}" name="idea_comment" rows="2"></textarea> <label class="idea-comments__label float-right">140 Zeichen übrig</label>
                  <a class="button button--yellow button--icon idea_comment_button" id="idea_comment_button_{{ idea.id }}" idea_id="{{ idea.id }}">Kommentieren</a>
              </div>    
            {% else %}
              <p class="white text-center">Dazu fällt dir was ein?<br><a class="button hollow" href="{% url 'register' %}">Jetzt registrieren</a><br><a class="text-link-special" href="{% url 'account_login' %}">oder anmelden.</a></p>
            {% endif %}

            <div id="idea_comments_{{idea.id}}">
              {% for comment in idea.comments.all %}
                <div class="idea-comments__item">
                <label class="idea-comments__label">VOR {{ comment.date|timesince|upper }} VON {% if comment.by_user.is_superuser %}SOCIALEE{% else %}{{ comment.by_user|upper|truncatechars:6 }}{% endif %}</label>
                  <p>{{ comment.message|urlizetrunc:25 }}</p>
                </div>
              {% endfor %}
            </div>

          </div>

          {% if request.user.is_superuser %}
          <div class="row align-center">
            <div class="small-12 columns text-center">
              admin only<br><a class="button hollow" href="{% url 'startprojectWithIdea' idea.pk %}">zum Projekt machen</a>
            </div>
          </div>
            
          {% endif %}
          

        </div>
      </div>
    </div>
  </div>  
</div>


{% addtoblock 'js' %}
<script type="text/javascript">
function idea_comment(idea_id, comment) {
    post_to_url( '{% url "idea_comment" %}',
                { idea_id : idea_id,
                  comment: comment
                },
                function(data){

                  var new_comment = $(data).find("#idea_comments_"+idea_id).first().children().first();
                  $(new_comment).css({ display: 'none'});
                  $("#idea_comments_"+idea_id).prepend(new_comment);
                  $(new_comment).slideDown('fast');
                  // $('html, body').animate({
                  //     scrollTop: ($(new_comment).offset().top-20)
                  // },500);
                });
  }

$(".idea_comment_button").click(
  function()
  {
    var id = $(this).attr('idea_id');
    if(  $.trim( $("#idea_comment_"+id).val()) )
      idea_comment(id, $("#idea_comment_"+id).val());
    $("#idea_comment_"+id).val("");
  });

function setNum() {
  if($(this).val().length > 140)
  {
    $(this).val($(this).val().substring(0,140));
  }
  var num = 140-$(this).val().length;
  $(this).parent().find("label").html(num +" Zeichen übrig");
}
$('.idea_comment_input').each(setNum);

$('.idea_comment_input').bind('input propertychange', setNum);
</script>
{% endaddtoblock %}

{% endblock content %}
